name: CI/CD Pipeline (Docker + Pi)

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    steps:
      - name: ì½”ë“œ ê°€ì ¸ì˜¤ê¸°
        uses: actions/checkout@v3

      - name: JDK 21 ì„¤ì • (Gradle ë¹Œë“œìš©)
        uses: actions/setup-java@v3
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: Gradle ê¶Œí•œ ë¶€ì—¬
        run: chmod +x ./cardcollector/gradlew

      - name: Spring Boot ë¹Œë“œ (í…ŒìŠ¤íŠ¸ ì œì™¸)
        run: |
          cd cardcollector
          ./gradlew build -x test

      - name: Docker Buildx ì„¤ì •
        uses: docker/setup-buildx-action@v2

      - name: ë„ì»¤ í—ˆë¸Œ ë¡œê·¸ì¸
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Docker ì´ë¯¸ì§€ ë¹Œë“œ ë° í‘¸ì‹œ (ARM64)
        uses: docker/build-push-action@v4
        with:
          context: .
          push: true
          tags: ${{ secrets.DOCKER_USERNAME }}/cardcollector:latest
          platforms: linux/arm64


  deploy-to-pi:
    needs: build-and-push 
    runs-on: self-hosted 
    steps:
      - name: ê¸°ì¡´ ì„œë²„ ë„ê³  ìƒˆ ë²„ì „ ì‹¤í–‰
        run: |
          # 1. ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì‚­ì œ (ì—†ìœ¼ë©´ íŒ¨ìŠ¤)
          docker rm -f my-server || true
          
          # 2. ìµœì‹  ì´ë¯¸ì§€ ë‹¹ê²¨ì˜¤ê¸°
          docker pull ${{ secrets.DOCKER_USERNAME }}/cardcollector:latest
          
          docker run -d \
            --name my-server \
            --restart always \
            --network host \
            --env-file /home/suhyun444/cardcollector-docker/server.env \
            ${{ secrets.DOCKER_USERNAME }}/cardcollector:latest

      # 3. ê²°ê³¼ ë””ìŠ¤ì½”ë“œ ì „ì†¡ (ê¸°ì¡´ ì½”ë“œ ì´ì‹ ì™„ë£Œ!)
      - name: Discord Notification
        uses: sarisia/actions-status-discord@v1
        if: always() 
        with:
          webhook: ${{ secrets.DISCORD_WEBHOOK }}
          status: ${{ job.status }}
          title: "ğŸš€ ë„ì»¤ ë°°í¬ ê²°ê³¼"
          description: "ë¼ì¦ˆë² ë¦¬íŒŒì´ ë°°í¬ê°€ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤! ê²°ê³¼: ${{ job.status }}"
          color: 0x008000 
          username: GitHub Actions
          avatar_url: https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png